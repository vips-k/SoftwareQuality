<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cucumber Scenario Builder (Dynamic)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide-icons"></script>
    <style>
        html { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #a0aec0; border-radius: 3px; }
        ::-webkit-scrollbar-track { background-color: #e2e8f0; }
        
        /* --- Flow Node --- */
        .flow-node {
            position: relative; padding: 0.75rem 1rem; margin: 0 auto 2.5rem auto;
            border: 1px solid #e5e7eb; border-radius: 0.5rem; background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            width: 90%; max-width: 320px;
        }
        .flow-node:not(:last-child)::after {
            content: ''; position: absolute; left: 50%; top: 100%;
            height: 2.5rem; width: 2px; background-color: #cbd5e1;
            transform: translateX(-50%);
        }
        .flow-node:not(:last-child)::before {
            content: 'â–¼'; position: absolute; left: 50%; top: 100%;
            margin-top: 1rem; transform: translateX(-50%); color: #94a3b8;
            font-size: 0.75rem; z-index: 10; background-color: #f8fafc; padding: 0 2px;
        }
        
        /* --- Parameter Inputs --- */
        .step-text-container {
            flex-grow: 1; font-size: 0.875rem; color: #1f2937; line-height: 2.5;
        }
        .param-group {
            display: inline-flex; border: 1px solid #d1d5db; border-radius: 6px;
            font-size: 0.875rem; vertical-align: middle;
        }
        .param-input-prefix, .param-input-suffix {
            width: 40px; padding: 2px 4px; border: none;
            background-color: #f3f4f6; color: #4b5563;
        }
        .param-input-prefix { border-right: 1px solid #d1d5db; border-radius: 5px 0 0 5px; }
        .param-input-suffix { border-left: 1px solid #d1d5db; border-radius: 0 5px 5px 0; }
        .param-input-value {
            width: 120px; padding: 2px 6px; border: none;
            font-weight: 500; color: #1d4ed8; background-color: #eff6ff;
        }
        .param-input-prefix:focus, .param-input-suffix:focus, .param-input-value:focus {
            outline: none; box-shadow: 0 0 0 2px #3b82f6; z-index: 10;
        }

        /* --- Editable Table --- */
        .editable-table { width: 100%; border-collapse: collapse; }
        .editable-table th, .editable-table td {
            border: 1px solid #d1d5db; padding: 2px;
        }
        .editable-table th { background-color: #f3f4f6; padding: 4px; }
        .table-header-input {
            width: 100%; border: none; background: transparent;
            font-weight: 600; text-align: left; padding: 4px;
        }
        .table-cell-input {
            width: 100%; border: none; background: transparent; padding: 4px;
        }
        .table-header-input:focus, .table-cell-input:focus {
            outline: none; background-color: white; box-shadow: 0 0 0 2px #3b82f6;
        }
        .btn-table-delete {
            color: #ef4444; background: transparent; border: none;
            cursor: pointer; padding: 4px; display: inline-block;
        }
        .btn-table-delete:hover { color: #b91c1c; }

        /* --- Flow Node Table --- */
        .flow-node-table {
            width: 100%; border-collapse: collapse; margin-top: 8px;
            font-size: 0.75rem;
        }
        .flow-node-table th, .flow-node-table td {
            border: 1px solid #e5e7eb; padding: 2px 4px;
            text-align: left;
        }
        .flow-node-table th { background-color: #f9fafb; }
    </style>
</head>
<body class="h-full flex flex-col overflow-hidden">
    <!-- Header -->
    <header class="bg-white p-4 border-b border-gray-200 shadow-sm z-10 flex-none flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900 flex items-center">
            <svg data-lucide="network" class="w-8 h-8 mr-2 text-indigo-600" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="16" y="16" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3"/><path d="M12 12V8"/></svg>
            Cucumber Scenario Builder
        </h1>
        <div>
            <label for="import-feature-file" class="cursor-pointer bg-teal-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-teal-700 flex items-center justify-center space-x-1">
                <i data-lucide="upload" class="w-4 h-4"></i>
                <span>Import .feature File</span>
            </label>
            <input type="file" id="import-feature-file" class="hidden" accept=".feature">
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left Panel: Scenarios, Palette, Export -->
        <aside class="w-1/3 max-w-lg flex-none flex flex-col h-full border-r border-gray-200 bg-white">
            <!-- Scenario List -->
            <div class="p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Scenarios</h2>
                <div class="flex space-x-2 mb-3">
                    <button id="btn-new-scenario" class="flex-1 bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 flex items-center justify-center space-x-1">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        <span>New Scenario</span>
                    </button>
                    <button id="btn-new-outline" class="flex-1 bg-sky-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-sky-700 flex items-center justify-center space-x-1">
                        <i data-lucide="table" class="w-4 h-4"></i>
                        <span>New Outline</span>
                    </button>
                </div>
                <div id="scenario-list-container" class="max-h-60 overflow-y-auto space-y-2"></div>
            </div>

            <!-- Feature Export -->
            <div class="p-4 border-b bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Feature Export</h2>
                <div class="space-y-3">
                    <input type="text" id="feature-export-name" placeholder="Feature: My Awesome Feature" class="w-full p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="btn-download-feature" class="w-full bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-green-700 flex items-center justify-center space-x-1">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span>Download .feature File</span>
                    </button>
                </div>
            </div>
            
            <!-- Statement Palette -->
            <div class="flex-1 p-4 overflow-y-auto" id="palette-container">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Statement Palette</h2>
                <div id="statement-palette" class="space-y-2"></div>
            </div>
        </aside>

        <!-- Center Panel: Scenario Editor -->
        <main class="flex-1 h-full flex flex-col overflow-hidden bg-gray-50">
            <div id="editor-placeholder" class="flex-1 flex items-center justify-center">
                <p class="text-lg text-gray-500">Select a scenario or create a new one to start.</p>
            </div>
            
            <div id="scenario-editor" class="hidden flex-1 flex flex-col overflow-hidden">
                <!-- Editor Header -->
                <div class="p-4 bg-white border-b border-gray-200 shadow-sm flex-none">
                    <input type="text" id="scenario-title" class="text-2xl font-bold text-gray-900 w-full p-2 rounded-lg hover:bg-gray-100 focus:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                </div>
                
                <!-- Editor Steps -->
                <div id="editor-steps-container" class="flex-1 p-6 overflow-y-auto space-y-2"></div>
                
                <!-- Examples Table Area -->
                <div id="examples-editor-container" class="hidden p-6 border-t border-gray-200 bg-white">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Examples:</h3>
                    <div id="examples-table-wrapper"></div>
                </div>

                <!-- Gherkin Output -->
                <div class="p-6 border-t border-gray-200 bg-gray-900 text-white flex-none">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold text-gray-100">Generated Gherkin</h3>
                        <button id="btn-copy-gherkin" class="flex items-center space-x-1.5 px-3 py-1.5 rounded-lg bg-gray-700 hover:bg-gray-600 text-sm font-medium text-gray-200">
                            <i data-lucide="clipboard-copy" class="w-4 h-4"></i>
                            <span id="copy-button-text">Copy</span>
                        </button>
                    </div>
                    <pre id="gherkin-output" class="p-4 rounded-md bg-gray-800 overflow-x-auto text-sm h-40"></pre>
                </div>
            </div>
        </main>

        <!-- Right Panel: Flow Visualizer -->
        <aside class="w-1/3 max-w-lg flex-none h-full border-l border-gray-200 bg-gray-50 overflow-y-auto p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">Flow Visualizer</h2>
            <div id="flow-visualizer-container">
                <div id="flow-placeholder" class="text-center text-gray-500 mt-10">
                    <i data-lucide="mouse-pointer-click" class="w-12 h-12 mx-auto text-gray-400"></i>
                    <p class="mt-4">Your scenario flow will appear here.</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- Global Datalist for parameters -->
    <datalist id="param-suggestions"></datalist>

    <!-- Templates -->
    <template id="scenario-list-item-template">
        <div class="scenario-list-item p-3 rounded-lg cursor-pointer group flex justify-between items-center bg-gray-50 hover:bg-gray-100">
            <div class="flex items-center">
                <input type="checkbox" class="scenario-export-checkbox mr-3 h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <div>
                    <span class="scenario-title font-medium text-gray-900">Scenario Title</span>
                    <span class="scenario-type block text-xs text-gray-500">Scenario</span>
                </div>
            </div>
            <button class="btn-delete-scenario text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
        </div>
    </template>

    <template id="palette-item-template">
        <button class="palette-item w-full flex items-center p-3 rounded-lg bg-gray-50 hover:bg-gray-100 border border-gray-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
            <span class="step-type flex-none w-20 text-center px-2 py-0.5 rounded-md text-xs font-bold text-white"></span>
            <span class="step-template-text ml-3 text-sm text-left text-gray-700"></span>
        </button>
    </template>

    <template id="editor-step-template">
        <div class="editor-step bg-white p-3 rounded-lg shadow-sm border border-gray-200">
            <!-- Step Header: Type, Text, Controls -->
            <div class="flex items-start space-x-2">
                <span class="step-type flex-none w-20 text-center px-2 py-1 rounded-md text-xs font-bold text-white mt-1"></span>
                <div class="step-text-container"></div>
                <!-- Action Buttons -->
                <div class="flex items-center space-x-1 flex-none">
                    <button class="btn-move-up p-2 rounded-md text-gray-500 hover:bg-gray-100 disabled:opacity-30" title="Move up"><i data-lucide="arrow-up" class="w-4 h-4"></i></button>
                    <button class="btn-move-down p-2 rounded-md text-gray-500 hover:bg-gray-100 disabled:opacity-30" title="Move down"><i data-lucide="arrow-down" class="w-4 h-4"></i></button>
                    <button class="btn-delete-step p-2 rounded-md text-red-500 hover:bg-red-100" title="Delete step"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>
            <!-- Data Table Editor (if required) -->
            <div class="data-table-container hidden mt-3 ml-22 pl-1"></div>
        </div>
    </template>

    <template id="flow-node-template">
        <div class="flow-node">
            <span class="step-type flex-none w-20 text-center px-2 py-0.5 rounded-md text-xs font-bold text-white"></span>
            <p class="step-text mt-2 text-sm text-gray-700"></p>
            <div class="flow-node-table-container"></div>
        </div>
    </template>
    
    <template id="editable-table-template">
        <table class="editable-table">
            <thead><tr class="table-header-row"></tr></thead>
            <tbody class="table-body"></tbody>
        </table>
        <div class="flex space-x-2 mt-2">
            <button class="btn-add-row bg-blue-500 text-white px-2 py-1 rounded-md text-xs font-medium hover:bg-blue-600 flex items-center space-x-1"><i data-lucide="plus" class="w-4 h-4"></i><span>Add Row</span></button>
            <button class="btn-add-col bg-green-500 text-white px-2 py-1 rounded-md text-xs font-medium hover:bg-green-600 flex items-center space-x-1"><i data-lucide="plus" class="w-4 h-4"></i><span>Add Column</span></button>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- STATE ---
            const PREDEFINED_STATEMENTS = [
                { id: 'g1', type: 'Given', template: 'I am on the "{pageName}" page', matcher: /^I am on the "(.*?)" page$/,
                  params: [{ name: 'pageName', options: ['login', 'dashboard', 'home', 'profile'] }],
                  dataTable: null },
                { id: 'g2', type: 'Given', template: 'a user with role "{role}" exists', matcher: /^a user with role "(.*?)" exists$/,
                  params: [{ name: 'role', options: ['admin', 'user', 'guest'] }],
                  dataTable: null },
                { id: 'g3', type: 'Given', template: 'the following users exist:', matcher: /^the following users exist:$/,
                  params: [],
                  dataTable: { headers: ['username', 'password', 'role'] } },
                { id: 'w1', type: 'When', template: 'I enter "{value}" in the "{field}" field', matcher: /^I enter "(.*?)" in the "(.*?)" field$/,
                  params: [{ name: 'value', options: [] }, { name: 'field', options: ['username', 'password', 'email'] }],
                  dataTable: null },
                { id: 'w2', type: 'When', template: 'I click the "{buttonName}" button', matcher: /^I click the "(.*?)" button$/,
                  params: [{ name: 'buttonName', options: ['Login', 'Submit', 'Cancel'] }],
                  dataTable: null },
                { id: 'w3', type: 'When', template: 'I fill in the form with:', matcher: /^I fill in the form with:$/,
                  params: [],
                  dataTable: { headers: ['field', 'value'] } },
                { id: 't1', type: 'Then', template: 'I should see the "{elementName}"', matcher: /^I should see the "(.*?)"$/,
                  params: [{ name: 'elementName', options: [] }],
                  dataTable: null },
                { id: 't2', type: 'Then', template: 'I should be redirected to the "{pageName}" page', matcher: /^I should be redirected to the "(.*?)" page$/,
                  params: [{ name: 'pageName', options: ['login', 'dashboard', 'home', 'profile'] }],
                  dataTable: null }
            ];
            
            const getStatement = (id) => PREDEFINED_STATEMENTS.find(s => s.id === id);

            let scenarios = [];
            let activeScenarioId = null;

            // --- DOM Elements ---
            const dom = {
                paletteContainer: document.getElementById('statement-palette'),
                scenarioListContainer: document.getElementById('scenario-list-container'),
                editorPlaceholder: document.getElementById('editor-placeholder'),
                scenarioEditor: document.getElementById('scenario-editor'),
                scenarioTitleInput: document.getElementById('scenario-title'),
                editorStepsContainer: document.getElementById('editor-steps-container'),
                examplesEditorContainer: document.getElementById('examples-editor-container'),
                examplesTableWrapper: document.getElementById('examples-table-wrapper'),
                flowVisualizerContainer: document.getElementById('flow-visualizer-container'),
                flowPlaceholder: document.getElementById('flow-placeholder'),
                gherkinOutput: document.getElementById('gherkin-output'),
                paramDatalist: document.getElementById('param-suggestions')
            };

            // --- Templates ---
            const templates = {
                paletteItem: document.getElementById('palette-item-template'),
                scenarioListItem: document.getElementById('scenario-list-item-template'),
                editorStep: document.getElementById('editor-step-template'),
                flowNode: document.getElementById('flow-node-template'),
                editableTable: document.getElementById('editable-table-template')
            };

            const getStepColor = (type) => ({
                'given': 'bg-blue-600', 'when': 'bg-green-600', 'then': 'bg-purple-600',
                'and': 'bg-gray-500', 'but': 'bg-red-600'
            })[type.toLowerCase()] || 'bg-gray-700';
            
            // --- Text & Gherkin Generation ---
            function getParamDisplayValue(param) {
                return `${param.prefix || ''}${param.value || ''}${param.suffix || ''}`;
            }

            function generateStepText(step) {
                const statement = getStatement(step.statementId);
                if (!statement) return "Unknown Step";
                
                let text = statement.template;
                statement.params.forEach(paramDef => {
                    const paramValue = step.paramValues[paramDef.name] || { value: '', prefix: '', suffix: '' };
                    const displayValue = getParamDisplayValue(paramValue);
                    const regex = new RegExp(`{\\s*${paramDef.name}\\s*}`, 'g');
                    // Gherkin syntax requires quotes around the value
                    text = text.replace(regex, `"${displayValue}"`);
                });
                return text;
            }

            // --- RENDER FUNCTIONS ---
            
            function updateParamDatalist() {
                dom.paramDatalist.innerHTML = '';
                const scenario = getActiveScenario();
                if (!scenario) return;

                const suggestions = new Set();
                
                // Add predefined options
                PREDEFINED_STATEMENTS.forEach(stmt => {
                    stmt.params.forEach(param => {
                        param.options.forEach(opt => suggestions.add(opt));
                    });
                });
                
                // Add example headers
                if (scenario.type === 'scenario_outline') {
                    scenario.examples.headers.forEach(header => {
                        if (header) suggestions.add(`<${header}>`);
                    });
                }
                
                suggestions.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    dom.paramDatalist.appendChild(option);
                });
            }
            
            function renderPalette() {
                dom.paletteContainer.innerHTML = '';
                PREDEFINED_STATEMENTS.forEach(statement => {
                    const node = templates.paletteItem.content.cloneNode(true);
                    const button = node.querySelector('.palette-item');
                    const typeEl = node.querySelector('.step-type');
                    
                    typeEl.textContent = statement.type;
                    typeEl.className += ` ${getStepColor(statement.type)}`;
                    node.querySelector('.step-template-text').textContent = statement.template;
                    
                    button.disabled = !activeScenarioId;
                    button.addEventListener('click', () => handleAddStep(statement.id));
                    
                    dom.paletteContainer.appendChild(node);
                });
            }

            function renderScenarioList() {
                dom.scenarioListContainer.innerHTML = '';
                if (scenarios.length === 0) {
                    dom.scenarioListContainer.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">No scenarios yet.</p>`;
                    return;
                }
                
                scenarios.forEach(scenario => {
                    const node = templates.scenarioListItem.content.cloneNode(true);
                    const item = node.querySelector('.scenario-list-item');
                    
                    item.dataset.scenarioId = scenario.id;
                    node.querySelector('.scenario-title').textContent = scenario.title;
                    node.querySelector('.scenario-type').textContent = scenario.type === 'scenario' ? 'Scenario' : 'Scenario Outline';
                    node.querySelector('.scenario-export-checkbox').dataset.scenarioId = scenario.id;
                    
                    if (scenario.id === activeScenarioId) {
                        item.classList.add('bg-indigo-100', 'border', 'border-indigo-500');
                    }
                    
                    item.querySelector('.scenario-title').addEventListener('click', () => handleSelectScenario(scenario.id));
                    node.querySelector('.btn-delete-scenario').addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleDeleteScenario(scenario.id);
                    });
                    
                    dom.scenarioListContainer.appendChild(node);
                });
            }
            
            function renderActiveScenario() {
                const scenario = getActiveScenario();
                
                if (!scenario) {
                    dom.editorPlaceholder.style.display = 'flex';
                    dom.scenarioEditor.style.display = 'none';
                    return;
                }
                
                dom.editorPlaceholder.style.display = 'none';
                dom.scenarioEditor.style.display = 'flex';
                
                dom.scenarioTitleInput.value = scenario.title;
                dom.editorStepsContainer.innerHTML = '';
                
                updateParamDatalist(); // Rebuild datalist based on example headers
                
                scenario.steps.forEach((step, index) => {
                    const node = templates.editorStep.content.cloneNode(true);
                    const stepEl = node.querySelector('.editor-step');
                    const typeEl = node.querySelector('.step-type');
                    const textContainer = node.querySelector('.step-text-container');
                    
                    const statement = getStatement(step.statementId);
                    
                    stepEl.dataset.stepId = step.id;
                    typeEl.textContent = statement.type;
                    typeEl.className += ` ${getStepColor(statement.type)}`;
                    
                    // --- Render Parametrized Text ---
                    textContainer.innerHTML = '';
                    const parts = statement.template.split(/({[^}]+})/g).filter(p => p.length > 0);
                    
                    parts.forEach(part => {
                        if (part.startsWith('{') && part.endsWith('}')) {
                            const paramName = part.substring(1, part.length - 1);
                            const paramValue = step.paramValues[paramName] || { value: '', prefix: '', suffix: '' };
                            
                            const group = document.createElement('span');
                            group.className = 'param-group';
                            
                            const prefixInput = document.createElement('input');
                            prefixInput.type = 'text';
                            prefixInput.className = 'param-input-prefix';
                            prefixInput.placeholder = 'Pre';
                            prefixInput.value = paramValue.prefix || '';
                            prefixInput.addEventListener('change', (e) => handleUpdateStepParam(step.id, paramName, 'prefix', e.target.value));
                            
                            const valueInput = document.createElement('input');
                            valueInput.type = 'text';
                            valueInput.className = 'param-input-value';
                            valueInput.placeholder = 'value';
                            valueInput.value = paramValue.value || '';
                            valueInput.setAttribute('list', 'param-suggestions');
                            valueInput.addEventListener('change', (e) => handleUpdateStepParam(step.id, paramName, 'value', e.target.value));
                            
                            const suffixInput = document.createElement('input');
                            suffixInput.type = 'text';
                            suffixInput.className = 'param-input-suffix';
                            suffixInput.placeholder = 'Suf';
                            suffixInput.value = paramValue.suffix || '';
                            suffixInput.addEventListener('change', (e) => handleUpdateStepParam(step.id, paramName, 'suffix', e.target.value));
                            
                            group.append(prefixInput, valueInput, suffixInput);
                            textContainer.appendChild(group);
                            
                        } else {
                            textContainer.appendChild(document.createTextNode(part));
                        }
                    });
                    
                    // --- Render Data Table ---
                    const tableContainer = node.querySelector('.data-table-container');
                    if (statement.dataTable) {
                        tableContainer.style.display = 'block';
                        const tableNode = createEditableTable(step.dataTable, 
                            (colIndex) => handleUpdateStepTable(step.id, 'header', colIndex),
                            (colIndex) => handleUpdateStepTable(step.id, 'delete-col', colIndex),
                            (rowIndex, colIndex) => handleUpdateStepTable(step.id, 'cell', rowIndex, colIndex),
                            (rowIndex) => handleUpdateStepTable(step.id, 'delete-row', rowIndex),
                            () => handleUpdateStepTable(step.id, 'add-row'),
                            () => handleUpdateStepTable(step.id, 'add-col')
                        );
                        tableContainer.appendChild(tableNode);
                    }
                    
                    // --- Move & Delete Buttons ---
                    const moveUpBtn = node.querySelector('.btn-move-up');
                    const moveDownBtn = node.querySelector('.btn-move-down');
                    moveUpBtn.disabled = index === 0;
                    moveDownBtn.disabled = index === scenario.steps.length - 1;
                    moveUpBtn.addEventListener('click', () => handleMoveStep(step.id, -1));
                    moveDownBtn.addEventListener('click', () => handleMoveStep(step.id, 1));
                    node.querySelector('.btn-delete-step').addEventListener('click', () => handleDeleteStep(step.id));
                    
                    dom.editorStepsContainer.appendChild(node);
                });
                
                // --- Render Examples ---
                if (scenario.type === 'scenario_outline') {
                    dom.examplesEditorContainer.style.display = 'block';
                    const tableNode = createEditableTable(scenario.examples,
                        (colIndex) => handleUpdateExamplesTable('header', colIndex),
                        (colIndex) => handleUpdateExamplesTable('delete-col', colIndex),
                        (rowIndex, colIndex) => handleUpdateExamplesTable('cell', rowIndex, colIndex),
                        (rowIndex) => handleUpdateExamplesTable('delete-row', rowIndex),
                        () => handleUpdateExamplesTable('add-row'),
                        () => handleUpdateExamplesTable('add-col')
                    );
                    dom.examplesTableWrapper.innerHTML = '';
                    dom.examplesTableWrapper.appendChild(tableNode);
                } else {
                    dom.examplesEditorContainer.style.display = 'none';
                }
                
                renderFlowVisualizer(scenario);
                renderGherkinOutput(scenario);
                lucide.createIcons();
            }

            // --- Generic Editable Table Renderer ---
            function createEditableTable(tableData, onHeaderChange, onColDelete, onCellChange, onRowDelete, onAddRow, onAddCol) {
                const tableRoot = templates.editableTable.content.cloneNode(true);
                const headerRow = tableRoot.querySelector('.table-header-row');
                const tableBody = tableRoot.querySelector('.table-body');

                // Headers
                tableData.headers.forEach((headerText, colIndex) => {
                    const th = document.createElement('th');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = headerText;
                    input.className = 'table-header-input';
                    input.addEventListener('change', (e) => onHeaderChange(colIndex, e.target.value));
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-table-delete';
                    deleteBtn.innerHTML = '<i data-lucide="x-circle" class="w-4 h-4"></i>';
                    deleteBtn.title = "Delete column";
                    deleteBtn.addEventListener('click', () => onColDelete(colIndex));
                    
                    th.append(input, deleteBtn);
                    headerRow.appendChild(th);
                });
                // Add empty header for row-delete column
                headerRow.appendChild(document.createElement('th'));
                
                // Rows
                tableData.rows.forEach((rowData, rowIndex) => {
                    const tr = document.createElement('tr');
                    rowData.forEach((cellData, colIndex) => {
                        const td = document.createElement('td');
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = cellData;
                        input.className = 'table-cell-input';
                        input.addEventListener('change', (e) => onCellChange(rowIndex, colIndex, e.target.value));
                        td.appendChild(input);
                        tr.appendChild(td);
                    });
                    
                    // Add delete row button
                    const deleteTd = document.createElement('td');
                    deleteTd.className = 'text-center';
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-table-delete';
                    deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
                    deleteBtn.title = "Delete row";
                    deleteBtn.addEventListener('click', () => onRowDelete(rowIndex));
                    deleteTd.appendChild(deleteBtn);
                    tr.appendChild(deleteTd);
                    
                    tableBody.appendChild(tr);
                });
                
                tableRoot.querySelector('.btn-add-row').addEventListener('click', onAddRow);
                tableRoot.querySelector('.btn-add-col').addEventListener('click', onAddCol);
                
                return tableRoot;
            }

            function renderFlowVisualizer(scenario) {
                dom.flowVisualizerContainer.innerHTML = '';
                if (!scenario || scenario.steps.length === 0) {
                    dom.flowVisualizerContainer.appendChild(dom.flowPlaceholder);
                    return;
                }
                
                scenario.steps.forEach(step => {
                    const node = templates.flowNode.content.cloneNode(true);
                    const typeEl = node.querySelector('.step-type');
                    const statement = getStatement(step.statementId);
                    
                    typeEl.textContent = statement.type;
                    typeEl.className += ` ${getStepColor(statement.type)}`;
                    
                    // Generate text for display (without quotes)
                    let text = statement.template;
                    statement.params.forEach(paramDef => {
                        const paramValue = step.paramValues[paramDef.name] || { value: '', prefix: '', suffix: '' };
                        const displayValue = getParamDisplayValue(paramValue);
                        const regex = new RegExp(`{\\s*${paramDef.name}\\s*}`, 'g');
                        text = text.replace(regex, `[${displayValue || paramDef.name}]`);
                    });
                    node.querySelector('.step-text').textContent = text;
                    
                    // --- Render flow node table ---
                    if (statement.dataTable) {
                        const tableContainer = node.querySelector('.flow-node-table-container');
                        const table = document.createElement('table');
                        table.className = 'flow-node-table';
                        
                        const thead = document.createElement('thead');
                        const headerRow = document.createElement('tr');
                        step.dataTable.headers.forEach(h => {
                            const th = document.createElement('th');
                            th.textContent = h;
                            headerRow.appendChild(th);
                        });
                        thead.appendChild(headerRow);
                        table.appendChild(thead);
                        
                        const tbody = document.createElement('tbody');
                        step.dataTable.rows.forEach(rowData => {
                            const tr = document.createElement('tr');
                            rowData.forEach(cellData => {
                                const td = document.createElement('td');
                                td.textContent = cellData;
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);
                        tableContainer.appendChild(table);
                    }
                    
                    dom.flowVisualizerContainer.appendChild(node);
                });
            }

            function renderGherkinOutput(scenario) {
                if (!scenario) {
                    dom.gherkinOutput.textContent = ''; return;
                }
                
                let text = `${scenario.type === 'scenario' ? 'Scenario' : 'Scenario Outline'}: ${scenario.title}\n`;
                
                scenario.steps.forEach(step => {
                  const statement = getStatement(step.statementId);
                  const stepText = generateStepText(step);
                  text += `  ${statement.type} ${stepText}\n`;
                  
                  if (statement.dataTable && step.dataTable.rows.length > 0) {
                      const headers = `| ${step.dataTable.headers.join(' | ')} |`;
                      text += `    ${headers}\n`;
                      step.dataTable.rows.forEach(row => {
                          const rowText = `| ${row.join(' | ')} |`;
                          text += `    ${rowText}\n`;
                      });
                  }
                });

                if (scenario.type === 'scenario_outline' && scenario.examples.rows.length > 0) {
                  text += `\n  Examples:\n`;
                  const headers = `| ${scenario.examples.headers.join(' | ')} |`;
                  text += `    ${headers}\n`;
                  scenario.examples.rows.forEach(row => {
                      const rowText = `| ${row.join(' | ')} |`;
                      text += `    ${rowText}\n`;
                  });
                }
                dom.gherkinOutput.textContent = text;
            }

            // --- EVENT HANDLERS ---
            
            function handleCreateScenario(type) {
                const newScenario = {
                  id: crypto.randomUUID(),
                  title: type === 'scenario' ? 'New Scenario' : 'New Scenario Outline',
                  type: type,
                  steps: [],
                  examples: {
                      headers: ['header1', 'header2'],
                      rows: [['value1', 'value2']]
                  },
                };
                scenarios.push(newScenario);
                activeScenarioId = newScenario.id;
                refreshAll();
            }

            function handleSelectScenario(id) {
                activeScenarioId = id;
                refreshAll();
            }

            function handleDeleteScenario(id) {
                scenarios = scenarios.filter(s => s.id !== id);
                if (activeScenarioId === id) {
                    activeScenarioId = scenarios[0]?.id || null;
                }
                refreshAll();
            }
            
            function getActiveScenario() {
                return scenarios.find(s => s.id === activeScenarioId);
            }

            function handleAddStep(statementId) {
                const scenario = getActiveScenario();
                if (!scenario) return;
                
                const statement = getStatement(statementId);
                const newStep = {
                  id: crypto.randomUUID(),
                  statementId: statementId,
                  paramValues: {},
                  dataTable: statement.dataTable ? {
                      headers: [...statement.dataTable.headers], // Copy headers
                      rows: []
                  } : null
                };
                
                statement.params.forEach(param => {
                    newStep.paramValues[param.name] = {
                        value: param.options[0] || '',
                        prefix: '',
                        suffix: ''
                    };
                });
                
                scenario.steps.push(newStep);
                renderActiveScenario();
            }
            
            function handleUpdateStepParam(stepId, paramName, field, value) {
                const step = getActiveScenario().steps.find(s => s.id === stepId);
                if (step) {
                    if (!step.paramValues[paramName]) {
                        step.paramValues[paramName] = { value: '', prefix: '', suffix: '' };
                    }
                    step.paramValues[paramName][field] = value;
                    renderFlowVisualizer(getActiveScenario());
                    renderGherkinOutput(getActiveScenario());
                }
            }
            
            // --- Step Data Table Handlers ---
            function handleUpdateStepTable(stepId, action, p1, p2) {
                const step = getActiveScenario().steps.find(s => s.id === stepId);
                const table = step.dataTable;
                
                switch(action) {
                    case 'header': table.headers[p1] = p2; break; // p1=colIdx, p2=value
                    case 'cell': table.rows[p1][p2] = p3; break; // p1=rowIdx, p2=colIdx, p3=value
                    case 'add-row': table.rows.push(new Array(table.headers.length).fill('')); break;
                    case 'delete-row': table.rows.splice(p1, 1); break; // p1=rowIdx
                    case 'add-col': 
                        table.headers.push('NewColumn');
                        table.rows.forEach(row => row.push(''));
                        break;
                    case 'delete-col': // p1=colIdx
                        table.headers.splice(p1, 1);
                        table.rows.forEach(row => row.splice(p1, 1));
                        break;
                }
                renderActiveScenario(); // Full re-render needed for table changes
            }

            // --- Examples Table Handlers ---
            function handleUpdateExamplesTable(action, p1, p2, p3) {
                const table = getActiveScenario().examples;
                
                switch(action) {
                    case 'header': table.headers[p1] = p2; updateParamDatalist(); break; // p1=colIdx, p2=value
                    case 'cell': table.rows[p1][p2] = p3; break; // p1=rowIdx, p2=colIdx, p3=value
                    case 'add-row': table.rows.push(new Array(table.headers.length).fill('')); break;
                    case 'delete-row': table.rows.splice(p1, 1); break; // p1=rowIdx
                    case 'add-col': 
                        table.headers.push('NewHeader');
                        table.rows.forEach(row => row.push(''));
                        updateParamDatalist();
                        break;
                    case 'delete-col': // p1=colIdx
                        table.headers.splice(p1, 1);
                        table.rows.forEach(row => row.splice(p1, 1));
                        updateParamDatalist();
                        break;
                }
                renderActiveScenario(); // Full re-render needed for table changes
            }
            
            function handleMoveStep(stepId, direction) {
                const scenario = getActiveScenario();
                const steps = scenario.steps;
                const index = steps.findIndex(s => s.id === stepId);
                if (index === -1) return;
                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= steps.length) return;
                [steps[index], steps[newIndex]] = [steps[newIndex], steps[index]];
                renderActiveScenario();
            }
            
            function handleDeleteStep(stepId) {
                const scenario = getActiveScenario();
                scenario.steps = scenario.steps.filter(s => s.id !== stepId);
                renderActiveScenario();
            }
            
            function handleCopyGherkin() {
                const text = dom.gherkinOutput.textContent;
                const copyButtonText = document.getElementById('copy-button-text');
                navigator.clipboard.writeText(text).then(() => {
                  copyButtonText.textContent = 'Copied!';
                  setTimeout(() => { copyButtonText.textContent = 'Copy'; }, 2000);
                }).catch(err => {
                  console.error('Failed to copy text: ', err);
                  // Fallback for sandbox
                  const textArea = document.createElement('textarea');
                  textArea.value = text;
                  document.body.appendChild(textArea);
                  textArea.select();
                  try {
                    document.execCommand('copy');
                    copyButtonText.textContent = 'Copied!';
                    setTimeout(() => { copyButtonText.textContent = 'Copy'; }, 2000);
                  } catch (e) {
                    copyButtonText.textContent = 'Failed!';
                  }
                  document.body.removeChild(textArea);
                });
            }

            function handleExportFeature() {
                const featureName = document.getElementById('feature-export-name').value || 'Feature: My Feature';
                let featureContent = `${featureName}\n\n`;
                
                const checkedCheckboxes = document.querySelectorAll('.scenario-export-checkbox:checked');
                if(checkedCheckboxes.length === 0) {
                    alert("Please select at least one scenario to export."); return;
                }
                
                checkedCheckboxes.forEach(checkbox => {
                    const scenarioId = checkbox.dataset.scenarioId;
                    const scenario = scenarios.find(s => s.id === scenarioId);
                    if (scenario) {
                        renderGherkinOutput(scenario); // Ensure gherkin output is up-to-date
                        featureContent += dom.gherkinOutput.textContent + "\n\n";
                    }
                });
                
                const blob = new Blob([featureContent], { type: 'text/plain;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'feature.feature';
                a.click();
            }
            
            function handleImportFeature(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    parseFeatureFile(e.target.result);
                };
                reader.readAsText(file);
                event.target.value = null;
            }
            
            function parseFeatureFile(content) {
                const lines = content.split('\n').map(l => l.trim());
                let currentScenario = null;
                let parsingState = 'NONE'; // NONE, STEPS, DATATABLE, EXAMPLES
                let currentStep = null;
                
                lines.forEach(line => {
                    if (line.startsWith('Feature:')) {
                        document.getElementById('feature-export-name').value = line;
                        return;
                    }
                    
                    if (line.startsWith('Scenario:') || line.startsWith('Scenario Outline:')) {
                        if (currentScenario) scenarios.push(currentScenario); // Save previous
                        
                        const isOutline = line.startsWith('Scenario Outline:');
                        currentScenario = {
                            id: crypto.randomUUID(),
                            title: line.substring(isOutline ? 17 : 9).trim(),
                            type: isOutline ? 'scenario_outline' : 'scenario',
                            steps: [],
                            examples: { headers: [], rows: [] },
                        };
                        parsingState = 'STEPS';
                        currentStep = null;
                        return;
                    }
                    
                    if (!currentScenario) return;

                    if (line.startsWith('Examples:')) {
                        parsingState = 'EXAMPLES';
                        currentStep = null;
                        return;
                    }
                    
                    if (line.startsWith('|')) {
                        const cells = line.split('|').slice(1, -1).map(s => s.trim());
                        if (parsingState === 'DATATABLE' && currentStep) {
                            currentStep.dataTable.rows.push(cells);
                        } else if (parsingState === 'EXAMPLES') {
                            if (currentScenario.examples.headers.length === 0) {
                                currentScenario.examples.headers = cells;
                            } else {
                                currentScenario.examples.rows.push(cells);
                            }
                        }
                    } else if (line.match(/^(Given|When|Then|And|But)\s(.*)$/)) {
                        parsingState = 'STEPS';
                        const match = line.match(/^(Given|When|Then|And|But)\s(.*)$/);
                        const stepText = match[2];
                        let matched = false;
                        
                        for (const statement of PREDEFINED_STATEMENTS) {
                            const regexMatch = stepText.match(statement.matcher);
                            if (regexMatch) {
                                currentStep = {
                                    id: crypto.randomUUID(),
                                    statementId: statement.id,
                                    paramValues: {},
                                    dataTable: statement.dataTable ? { headers: [...statement.dataTable.headers], rows: [] } : null
                                };
                                
                                const paramValues = regexMatch.slice(1);
                                statement.params.forEach((param, index) => {
                                    currentStep.paramValues[param.name] = { value: paramValues[index] || '', prefix: '', suffix: '' };
                                });
                                
                                currentScenario.steps.push(currentStep);
                                if (statement.dataTable) {
                                    parsingState = 'DATATABLE';
                                }
                                matched = true;
                                break;
                            }
                        }
                        if (!matched) {
                            console.warn(`Skipping unmatched step: ${line}`);
                            currentStep = null;
                        }
                    } else {
                        // End of a table
                        if (parsingState === 'DATATABLE') parsingState = 'STEPS';
                        currentStep = null;
                    }
                });
                
                if (currentScenario) scenarios.push(currentScenario);
                refreshAll();
            }

            // --- Global Event Listeners ---
            document.getElementById('btn-new-scenario').addEventListener('click', () => handleCreateScenario('scenario'));
            document.getElementById('btn-new-outline').addEventListener('click', () => handleCreateScenario('scenario_outline'));
            document.getElementById('btn-copy-gherkin').addEventListener('click', handleCopyGherkin);
            document.getElementById('btn-download-feature').addEventListener('click', handleExportFeature);
            document.getElementById('import-feature-file').addEventListener('change', handleImportFeature);
            
            dom.scenarioTitleInput.addEventListener('change', (e) => {
                const scenario = getActiveScenario();
                if (scenario) {
                    scenario.title = e.target.value;
                    renderScenarioList();
                    renderGherkinOutput(scenario);
                }
            });

            // --- INITIALIZATION ---
            function refreshAll() {
                renderPalette();
                renderScenarioList();
                renderActiveScenario();
            }

            function initializeApp() {
                // Add a default scenario for demo
                handleCreateScenario('scenario_outline');
                const scenario = getActiveScenario();
                activeScenarioId = scenario.id;
                handleAddStep('g1'); // "I am on the '{pageName}' page"
                handleAddStep('w3'); // "I fill in the form with:"
                
                scenario.title = "Example Login Outline";
                scenario.steps[0].paramValues.pageName.value = '<page>'; // Use example header
                scenario.steps[1].dataTable.rows.push(['username', '<username>']);
                scenario.steps[1].dataTable.rows.push(['password', '<password>']);
                
                scenario.examples = {
                    headers: ['page', 'username', 'password'],
                    rows: [
                        ['login', 'admin', 'admin123'],
                        ['login', 'user', 'user123']
                    ]
                };
                
                refreshAll();
                lucide.createIcons();
            }

            initializeApp();
        });
    </script>
</body>
</html>